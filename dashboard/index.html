<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Memory Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a0a; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
code, .mono { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; }

/* Stats Bar */
.stats-bar {
  display: flex; gap: 24px; padding: 16px 24px;
  background: #111; border-bottom: 1px solid #222;
}
.stat { text-align: center; }
.stat-value { font-size: 28px; font-weight: 700; }
.stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-active .stat-value { color: #3b82f6; }
.stat-done .stat-value { color: #22c55e; }
.stat-explore .stat-value { color: #a855f7; }
.stat-total .stat-value { color: #e0e0e0; }

/* Layout */
.main { display: flex; height: calc(100vh - 70px); }
.kanban-area { flex: 1; overflow-x: auto; padding: 16px; }
.sidebar { width: 320px; border-left: 1px solid #222; padding: 16px; overflow-y: auto; flex-shrink: 0; }

/* Kanban */
.kanban { display: flex; gap: 12px; height: 100%; }
.column { flex: 1; min-width: 220px; background: #111; border-radius: 8px; display: flex; flex-direction: column; }
.column-header { padding: 12px; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid; }
.col-active .column-header { border-color: #3b82f6; color: #3b82f6; }
.col-blocked .column-header { border-color: #ef4444; color: #ef4444; }
.col-done .column-header { border-color: #22c55e; color: #22c55e; }
.col-abandoned .column-header { border-color: #6b7280; color: #6b7280; }
.column-body { padding: 8px; overflow-y: auto; flex: 1; }

/* Cards */
.card {
  background: #1a1a1a; border: 1px solid #333; border-radius: 6px;
  padding: 10px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.15s;
}
.card:hover { border-color: #555; }
.card-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; word-break: break-word; }
.card-meta { font-size: 11px; color: #888; font-family: 'SF Mono', monospace; }
.card-meta span { margin-right: 10px; }
.card-detail { display: none; margin-top: 8px; font-size: 12px; color: #aaa; border-top: 1px solid #333; padding-top: 8px; }
.card.expanded .card-detail { display: block; }

/* Sidebar */
.sidebar h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; margin-bottom: 12px; }
.activity-item {
  padding: 8px 0; border-bottom: 1px solid #1a1a1a; font-size: 13px;
}
.activity-title { font-weight: 500; }
.activity-time { font-size: 11px; color: #666; font-family: 'SF Mono', monospace; }

/* Refresh indicator */
.refresh { position: fixed; top: 8px; right: 8px; font-size: 11px; color: #444; }

@media (max-width: 900px) {
  .main { flex-direction: column; }
  .sidebar { width: 100%; border-left: none; border-top: 1px solid #222; max-height: 300px; }
  .kanban { flex-wrap: wrap; }
  .column { min-width: 180px; }
}
</style>
</head>
<body>

<div class="stats-bar" id="stats-bar">
  <div class="stat stat-total"><div class="stat-value" id="stat-total">-</div><div class="stat-label">Total Notes</div></div>
  <div class="stat stat-active"><div class="stat-value" id="stat-active">-</div><div class="stat-label">Active Tasks</div></div>
  <div class="stat stat-done"><div class="stat-value" id="stat-done">-</div><div class="stat-label">Completed</div></div>
  <div class="stat stat-explore"><div class="stat-value" id="stat-explore">-</div><div class="stat-label">Explorations</div></div>
</div>

<div class="main">
  <div class="kanban-area">
    <div class="kanban">
      <div class="column col-active"><div class="column-header">Active <span class="col-count"></span></div><div class="column-body" id="col-active"></div></div>
      <div class="column col-blocked"><div class="column-header">Blocked <span class="col-count"></span></div><div class="column-body" id="col-blocked"></div></div>
      <div class="column col-done"><div class="column-header">Done <span class="col-count"></span></div><div class="column-body" id="col-done"></div></div>
      <div class="column col-abandoned"><div class="column-header">Abandoned <span class="col-count"></span></div><div class="column-body" id="col-abandoned"></div></div>
    </div>
  </div>
  <div class="sidebar">
    <h2>Activity Feed</h2>
    <div id="activity-feed"></div>
  </div>
</div>

<div class="refresh" id="refresh">‚è≥</div>

<script>
const API = '';

function makeCard(task) {
  const fm = task.frontmatter || {};
  const status = (fm.status || 'active').toLowerCase();
  const step = fm.current_step || '?';
  const total = fm.total_steps || '?';
  const assigned = fm.assigned_to || '';
  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `
    <div class="card-title">${esc(task.title)}</div>
    <div class="card-meta">
      ${assigned ? `<span>üë§ ${esc(assigned)}</span>` : ''}
      <span>üìä ${esc(String(step))}/${esc(String(total))}</span>
    </div>
    <div class="card-detail mono">${esc(task.content || '').slice(0, 300)}</div>
  `;
  div.onclick = () => div.classList.toggle('expanded');
  return { el: div, status };
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function fetchJson(url) {
  try { const r = await fetch(url); return r.ok ? r.json() : null; } catch { return null; }
}

async function refresh() {
  document.getElementById('refresh').textContent = 'üîÑ';

  const [tasks, activity, stats] = await Promise.all([
    fetchJson(`${API}/api/tasks`),
    fetchJson(`${API}/api/activity`),
    fetchJson(`${API}/api/stats`),
  ]);

  // Stats
  if (stats) {
    document.getElementById('stat-total').textContent = stats.totalNotes;
    document.getElementById('stat-active').textContent = stats.activeTasks;
    document.getElementById('stat-done').textContent = stats.completedTasks;
    document.getElementById('stat-explore').textContent = stats.explorations;
  }

  // Kanban
  const cols = { active: [], blocked: [], done: [], abandoned: [] };
  if (tasks) {
    for (const t of tasks) {
      const { el, status } = makeCard(t);
      const bucket = cols[status] ? status : 'active';
      cols[bucket].push(el);
    }
  }
  for (const [key, items] of Object.entries(cols)) {
    const container = document.getElementById(`col-${key}`);
    container.innerHTML = '';
    for (const el of items) container.appendChild(el);
    container.parentElement.querySelector('.col-count').textContent = `(${items.length})`;
  }

  // Activity
  const feed = document.getElementById('activity-feed');
  feed.innerHTML = '';
  if (activity?.length) {
    for (const a of activity.slice(0, 30)) {
      const div = document.createElement('div');
      div.className = 'activity-item';
      const time = a.created_at ? new Date(a.created_at).toLocaleTimeString() : '';
      div.innerHTML = `<div class="activity-title">${esc(a.title)}</div><div class="activity-time">${time}</div>`;
      feed.appendChild(div);
    }
  } else {
    feed.innerHTML = '<div style="color:#555">No recent activity</div>';
  }

  document.getElementById('refresh').textContent = '‚úì';
  setTimeout(() => { document.getElementById('refresh').textContent = ''; }, 2000);
}

refresh();
setInterval(refresh, 30000);
</script>
</body>
</html>
